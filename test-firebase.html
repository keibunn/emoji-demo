<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 排行榜测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #leaderboard {
            margin-top: 20px;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 Firebase 排行榜测试</h1>
        
        <div id="status" class="status info">
            初始化中...
        </div>
        
        <div>
            <h3>🧪 测试功能</h3>
            <button onclick="testSubmitScore()">提交测试分数</button>
            <button onclick="testMultipleScores()">测试多次提交（验证去重）</button>
            <button onclick="loadLeaderboard()">加载排行榜</button>
            <button onclick="clearResults()">清除结果</button>
        </div>
        
        <div>
            <h3>⚙️ 玩家设置</h3>
            <input type="text" id="playerName" placeholder="输入自定义昵称" style="padding: 8px; margin-right: 10px;">
            <button onclick="setCustomName()">设置昵称</button>
            <div id="currentPlayer" style="margin-top: 10px;"></div>
        </div>
        
        <div id="leaderboard">
            <h3>🏆 排行榜</h3>
            <div id="leaderboardContent">点击"加载排行榜"查看数据</div>
        </div>
        
        <div id="results" style="margin-top: 20px;">
            <h3>📋 测试结果</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase 配置 -->
    <script src="scripts/firebase-config.js"></script>
    <script src="scripts/leaderboard.js"></script>
    
    <script>
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addResult(message) {
            const resultEl = document.getElementById('resultContent');
            const time = new Date().toLocaleTimeString();
            resultEl.innerHTML += `<div>[${time}] ${message}</div>`;
        }
        
        function clearResults() {
            document.getElementById('resultContent').innerHTML = '';
        }
        
        // 检查Firebase初始化状态
        setTimeout(() => {
            if (window.firebaseDatabase && window.leaderboard) {
                updateStatus('Firebase 初始化成功！可以开始测试', 'success');
                showCurrentPlayer();
            } else {
                updateStatus('Firebase 初始化失败！请检查配置', 'error');
            }
        }, 1000);
        
        function showCurrentPlayer() {
            if (window.leaderboard) {
                const playerId = window.leaderboard.generatePlayerId();
                const playerName = window.leaderboard.getPlayerName();
                document.getElementById('currentPlayer').innerHTML = 
                    `<strong>当前玩家:</strong> ${playerName} (ID: ${playerId.substring(0, 8)}...)`;
            }
        }
        
        async function testSubmitScore() {
            if (!window.leaderboard) {
                addResult('❌ 排行榜功能未初始化');
                return;
            }
            
            const randomScore = Math.floor(Math.random() * 1000) + 100;
            addResult(`🎯 正在提交测试分数: ${randomScore}`);
            
            try {
                const success = await window.leaderboard.submitScore(randomScore, 1);
                if (success) {
                    addResult(`✅ 分数提交成功！分数: ${randomScore}`);
                    updateStatus('分数提交成功！', 'success');
                } else {
                    addResult('❌ 分数提交失败');
                    updateStatus('分数提交失败', 'error');
                }
            } catch (error) {
                addResult(`❌ 提交错误: ${error.message}`);
                updateStatus('提交出现错误', 'error');
            }
        }

        async function testMultipleScores() {
            if (!window.leaderboard) {
                addResult('❌ 排行榜功能未初始化');
                return;
            }
            
            addResult('🧪 开始测试多次提交（验证去重逻辑）...');
            
            const testScores = [150, 200, 175, 250, 180]; // 模拟多次游戏分数
            
            try {
                for (let i = 0; i < testScores.length; i++) {
                    const score = testScores[i];
                    addResult(`📤 提交第${i+1}次分数: ${score}`);
                    
                    const success = await window.leaderboard.submitScore(score, 1);
                    if (success) {
                        addResult(`✅ 第${i+1}次提交成功`);
                    } else {
                        addResult(`❌ 第${i+1}次提交失败`);
                    }
                    
                    // 短暂延迟，避免提交太快
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                addResult('🎯 多次提交完成！现在加载排行榜查看去重效果...');
                updateStatus('多次提交测试完成！', 'success');
                
                // 自动加载排行榜查看效果
                setTimeout(loadLeaderboard, 1000);
                
            } catch (error) {
                addResult(`❌ 多次提交测试出错: ${error.message}`);
                updateStatus('多次提交测试失败', 'error');
            }
        }
        
        async function loadLeaderboard() {
            if (!window.leaderboard) {
                addResult('❌ 排行榜功能未初始化');
                return;
            }
            
            addResult('📊 正在加载排行榜...');
            
            try {
                const data = await window.leaderboard.getLeaderboard(10);
                
                if (data.length === 0) {
                    document.getElementById('leaderboardContent').innerHTML = 
                        '<div style="text-align: center; color: #666;">暂无排行榜数据</div>';
                    addResult('📋 排行榜暂无数据');
                } else {
                    let html = '';
                    data.forEach((entry, index) => {
                        const rank = index + 1;
                        const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}.`;
                        html += `
                            <div class="rank-item">
                                <span>${medal} ${entry.playerName}</span>
                                <span><strong>${entry.score}</strong> 分</span>
                            </div>
                        `;
                    });
                    document.getElementById('leaderboardContent').innerHTML = html;
                    addResult(`✅ 成功加载 ${data.length} 条排行榜记录`);
                    updateStatus(`排行榜加载成功，共 ${data.length} 条记录`, 'success');
                }
            } catch (error) {
                addResult(`❌ 加载错误: ${error.message}`);
                updateStatus('排行榜加载失败', 'error');
                document.getElementById('leaderboardContent').innerHTML = 
                    '<div style="color: red;">加载失败，请检查网络连接</div>';
            }
        }
        
        function setCustomName() {
            const nameInput = document.getElementById('playerName');
            const newName = nameInput.value.trim();
            
            if (!newName) {
                addResult('❌ 请输入有效的昵称');
                return;
            }
            
            if (window.leaderboard) {
                const setName = window.leaderboard.setPlayerName(newName);
                addResult(`✅ 昵称已设置为: ${setName}`);
                showCurrentPlayer();
                nameInput.value = '';
            } else {
                addResult('❌ 排行榜功能未初始化');
            }
        }
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeEl = document.activeElement;
                if (activeEl.id === 'playerName') {
                    setCustomName();
                }
            }
        });
    </script>
</body>
</html> 